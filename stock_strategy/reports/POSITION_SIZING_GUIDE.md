# 仓位管理实盘指南

**组合**: MSFT 30% + GOOGL 25% + NVDA 20% + TSLA 15% + AAPL 10%
**总资金**: $100,000（示例）

---

## 🎯 两层仓位管理体系

### 第一层：股票配置比例（战略层）

```yaml
资金分配:
  MSFT:  $30,000 (30%)  # 这是该股票的"资金池"
  GOOGL: $25,000 (25%)
  NVDA:  $20,000 (20%)
  TSLA:  $15,000 (15%)
  AAPL:  $10,000 (10%)
```

**这个比例的含义**：
- ✅ 这是每只股票的"最大可用资金"
- ✅ 不是说MSFT一定要一直持有$30,000
- ✅ 而是说MSFT最多可以使用$30,000去交易

---

### 第二层：单次买入仓位（战术层）⭐ 关键

**问题**: 当MSFT出现买入信号时，应该买入多少？

#### 方案A: 固定金额法（不推荐）❌

```yaml
MSFT买入信号触发:
  每次都买入 $30,000（初始资金池的100%）

问题:
  - 第一次买入后，现金用完
  - 第二次买入信号无法执行
  - 无法复利增长
```

**结论**: ❌ 不推荐，太死板

---

#### 方案B: 固定比例法（推荐）⭐⭐⭐

```yaml
MSFT买入信号触发:
  每次买入 = MSFT当前资金池 × 50%（或其他比例）

示例:
  初始MSFT资金池: $30,000

  第1次买入信号:
    买入金额 = $30,000 × 50% = $15,000
    剩余现金 = $15,000

  第2次买入信号（假设第1次已平仓盈利+10%）:
    MSFT资金池更新为 = $15,000（剩余）+ $16,500（平仓收入）= $31,500
    买入金额 = $31,500 × 50% = $15,750
    剩余现金 = $15,750
```

**优点**:
- ✅ 盈利后买入金额增加（复利效应）
- ✅ 始终保持50%现金储备
- ✅ 可以应对多次买入信号

**推荐比例**:
- 保守: 30-40%
- 平衡: 50-60% ⭐
- 激进: 70-80%

---

#### 方案C: 凯利公式法（高级）⭐⭐

```yaml
根据历史胜率和盈亏比动态调整买入比例

凯利比例 = (胜率 × 盈亏比 - 败率) / 盈亏比

示例（MSFT）:
  胜率: 100% (4/4窗口盈利)
  平均盈利: 23.98%
  平均亏损: 0%（无亏损窗口）
  盈亏比: 无穷大

  → 理论上可以100%仓位（但实际要打折）
  → 建议: 70% × 0.5（安全系数）= 35%

示例（AAPL）:
  胜率: 50% (2/4窗口盈利)
  盈亏比: 1.5（假设）
  凯利比例 = (0.5 × 1.5 - 0.5) / 1.5 = 0.17

  → 建议仓位: 17%
```

**优点**:
- ✅ 科学，根据历史表现调整
- ✅ 高胜率高仓位，低胜率低仓位

**缺点**:
- ⚠️ 计算复杂
- ⚠️ 需要持续更新数据

---

## 🎯 推荐方案：分级固定比例法

根据各股票的评级，使用不同的买入比例：

```yaml
买入比例配置:
  MSFT (A级):  60%  # 高评分高仓位
  GOOGL (B级): 50%  # 良好评分中等仓位
  NVDA (C级):  40%  # 低评分低仓位
  TSLA (C级):  40%
  AAPL (C级):  30%  # 最低评分最低仓位

解释:
  - A级股票用60%（更激进，因为更可靠）
  - B级股票用50%（平衡）
  - C级股票用30-40%（保守，因为不稳定）
```

---

## 📝 实盘示例（完整流程）

### 初始状态（2026年1月1日）

```yaml
总资金: $100,000

各股票资金池:
  MSFT:  $30,000 (30%) - 现金: $30,000, 持仓: $0
  GOOGL: $25,000 (25%) - 现金: $25,000, 持仓: $0
  NVDA:  $20,000 (20%) - 现金: $20,000, 持仓: $0
  TSLA:  $15,000 (15%) - 现金: $15,000, 持仓: $0
  AAPL:  $10,000 (10%) - 现金: $10,000, 持仓: $0
```

---

### 第1天：MSFT出现买入信号

```yaml
触发条件: MSFT情绪指数(S3) < -5

执行:
  MSFT当前资金池: $30,000
  买入比例: 60%（A级）
  买入金额: $30,000 × 60% = $18,000
  MSFT股价: $400
  买入股数: $18,000 / $400 = 45股

更新后状态:
  MSFT - 现金: $12,000, 持仓: $18,000 (45股@$400)
  其他股票 - 不变

总仓位:
  现金: $82,000 ($12,000 + $25,000 + $20,000 + $15,000 + $10,000)
  持仓: $18,000 (MSFT)
  总资产: $100,000
```

---

### 第10天：GOOGL也出现买入信号

```yaml
触发条件: GOOGL情绪指数(S5) < -5

执行:
  GOOGL当前资金池: $25,000
  买入比例: 50%（B级）
  买入金额: $25,000 × 50% = $12,500
  GOOGL股价: $150
  买入股数: $12,500 / $150 = 83股

更新后状态:
  MSFT - 现金: $12,000, 持仓: $18,000 (45股@$400)
  GOOGL - 现金: $12,500, 持仓: $12,500 (83股@$150)
  其他 - 现金不变

总仓位:
  现金: $69,500
  持仓: $30,500 (MSFT $18,000 + GOOGL $12,500)
  总资产: $100,000
```

---

### 第30天：MSFT触发卖出信号（盈利）

```yaml
触发条件: MSFT情绪指数(S3) > 40 (or条件)

执行:
  持仓: 45股 @ $400
  当前价格: $450
  卖出收入: 45 × $450 × 0.998 (扣除0.2%手续费) = $20,092
  盈利: $20,092 - $18,000 = $2,092 (+11.6%)

更新后状态:
  MSFT - 现金: $32,092 ($12,000 + $20,092), 持仓: $0
  GOOGL - 现金: $12,500, 持仓: $12,500
  其他 - 不变

总仓位:
  现金: $91,592
  持仓: $12,500 (GOOGL)
  总资产: $104,092 ✅ 盈利4.09%
```

---

### 第40天：MSFT再次出现买入信号（复利）

```yaml
触发条件: MSFT情绪指数(S3) < -5

执行:
  MSFT当前资金池: $32,092（包含上次盈利）⭐
  买入比例: 60%（A级）
  买入金额: $32,092 × 60% = $19,255 ⭐ 比第一次多
  MSFT股价: $420
  买入股数: $19,255 / $420 = 45.8股

更新后状态:
  MSFT - 现金: $12,837, 持仓: $19,255 (45.8股@$420)

关键:
  ✅ 第1次买入: $18,000
  ✅ 第2次买入: $19,255（+7%）⭐ 复利效应
```

---

## 📊 不同买入比例的对比

假设MSFT初始资金池$30,000，连续3次买入信号，每次都盈利10%：

### 30%买入比例（保守）

```
第1次: 买入$9,000  → 平仓$9,900  → 资金池$30,900
第2次: 买入$9,270  → 平仓$10,197 → 资金池$31,827
第3次: 买入$9,548  → 平仓$10,503 → 资金池$32,782

最终盈利: +9.3%
```

### 50%买入比例（平衡）⭐

```
第1次: 买入$15,000 → 平仓$16,500 → 资金池$31,500
第2次: 买入$15,750 → 平仓$17,325 → 资金池$33,075
第3次: 买入$16,537 → 平仓$18,191 → 资金池$34,729

最终盈利: +15.8% ⭐
```

### 70%买入比例（激进）

```
第1次: 买入$21,000 → 平仓$23,100 → 资金池$32,100
第2次: 买入$22,470 → 平仓$24,717 → 资金池$34,347
第3次: 买入$24,043 → 平仓$26,447 → 资金池$36,751

最终盈利: +22.5%
```

### 100%买入比例（all-in）❌

```
第1次: 买入$30,000 → 平仓$33,000 → 资金池$33,000
第2次: 无法买入（等待下次信号）❌
第3次: 买入$33,000 → 平仓$36,300 → 资金池$36,300

最终盈利: +21.0%

问题:
  - 错过了第2次机会
  - 虽然单次all-in盈利大，但错过机会损失更大
```

**结论**: 50-60%是最优平衡点 ⭐

---

## 🎯 最终推荐配置

### 推荐方案：分级比例 + 动态复利

```yaml
初始配置:
  总资金: $100,000

  MSFT:  $30,000 - 每次买入60%（A级）
  GOOGL: $25,000 - 每次买入50%（B级）
  NVDA:  $20,000 - 每次买入40%（C级）
  TSLA:  $15,000 - 每次买入40%（C级）
  AAPL:  $10,000 - 每次买入30%（C级最弱）

买入逻辑:
  当某股票出现买入信号时:
    1. 检查该股票当前资金池（现金部分）
    2. 计算买入金额 = 资金池现金 × 买入比例
    3. 执行买入
    4. 更新资金池状态

卖出逻辑:
  当某股票出现卖出信号时:
    1. 平仓全部持仓
    2. 收入归入该股票资金池
    3. 资金池 = 原剩余现金 + 平仓收入
    4. 等待下次买入信号

复利效应:
  ✅ 盈利归入资金池 → 下次买入金额增加
  ✅ 亏损归入资金池 → 下次买入金额减少
  ✅ 自动调整，无需人工干预
```

---

## ⚠️ 特殊情况处理

### 1. 同时多个买入信号

```yaml
场景: MSFT和GOOGL同时触发买入信号

处理:
  方案A - 全部执行（推荐）:
    MSFT买入: $30,000 × 60% = $18,000
    GOOGL买入: $25,000 × 50% = $12,500
    总买入: $30,500

  方案B - 按优先级:
    优先级: A级 > B级 > C级
    先买MSFT（A级），如果现金不足再放弃GOOGL
```

### 2. 资金池耗尽

```yaml
场景: MSFT买入信号触发，但资金池现金不足$1000

处理:
  跳过该信号
  等待当前持仓平仓后再执行

示例:
  MSFT资金池: 现金$500，持仓$29,500
  买入信号触发 → 跳过
  等待持仓平仓后 → 资金池现金恢复 → 可执行
```

### 3. 重新平衡（可选）

```yaml
场景: 1年后，各股票资金池严重失衡

初始:
  MSFT:  $30,000 (30%)
  GOOGL: $25,000 (25%)
  NVDA:  $20,000 (20%)
  TSLA:  $15,000 (15%)
  AAPL:  $10,000 (10%)

1年后:
  MSFT:  $50,000 (40%) ⬆️ 大幅增长
  GOOGL: $30,000 (24%)
  NVDA:  $20,000 (16%) ⬇️
  TSLA:  $15,000 (12%)
  AAPL:  $10,000 (8%)  ⬇️
  总资产: $125,000

是否重新平衡？

方案A - 不重新平衡（推荐）:
  让赢家继续赢
  MSFT表现好，自然应该占更多

方案B - 重新平衡:
  MSFT:  $125,000 × 30% = $37,500（减少$12,500）
  AAPL:  $125,000 × 10% = $12,500（增加$2,500）

  问题:
    - 卖出赢家（MSFT），买入输家（AAPL）
    - 可能违背"趋势持续"原则
```

**建议**: 年度复盘时决定，一般不重新平衡

---

## 💡 实盘代码示例

```python
class PortfolioManager:
    def __init__(self, initial_capital=100000):
        # 初始化各股票资金池
        self.pools = {
            'MSFT':  {'total': 30000, 'cash': 30000, 'position': 0, 'shares': 0, 'buy_pct': 0.60},
            'GOOGL': {'total': 25000, 'cash': 25000, 'position': 0, 'shares': 0, 'buy_pct': 0.50},
            'NVDA':  {'total': 20000, 'cash': 20000, 'position': 0, 'shares': 0, 'buy_pct': 0.40},
            'TSLA':  {'total': 15000, 'cash': 15000, 'position': 0, 'shares': 0, 'buy_pct': 0.40},
            'AAPL':  {'total': 10000, 'cash': 10000, 'position': 0, 'shares': 0, 'buy_pct': 0.30},
        }

    def buy(self, symbol, price):
        """执行买入"""
        pool = self.pools[symbol]

        # 检查是否已有持仓
        if pool['shares'] > 0:
            print(f"{symbol}: 已有持仓，跳过买入")
            return False

        # 计算买入金额
        buy_amount = pool['cash'] * pool['buy_pct']

        if buy_amount < 1000:
            print(f"{symbol}: 可用资金不足$1000，跳过买入")
            return False

        # 计算股数（扣除手续费和滑点）
        shares = int(buy_amount / (price * 1.002))
        actual_cost = shares * price * 1.002

        # 更新资金池
        pool['cash'] -= actual_cost
        pool['shares'] = shares
        pool['position'] = shares * price
        pool['entry_price'] = price * 1.002

        print(f"{symbol}: 买入 {shares}股 @ ${price:.2f}, 花费${actual_cost:.2f}")
        print(f"  剩余现金: ${pool['cash']:.2f}")
        return True

    def sell(self, symbol, price):
        """执行卖出"""
        pool = self.pools[symbol]

        if pool['shares'] == 0:
            print(f"{symbol}: 无持仓，跳过卖出")
            return False

        # 计算卖出收入（扣除手续费和滑点）
        revenue = pool['shares'] * price * 0.998
        profit = revenue - (pool['shares'] * pool['entry_price'])
        profit_pct = (profit / (pool['shares'] * pool['entry_price'])) * 100

        # 更新资金池
        pool['cash'] += revenue
        pool['total'] = pool['cash']  # 更新总资金池
        pool['shares'] = 0
        pool['position'] = 0

        print(f"{symbol}: 卖出 @ ${price:.2f}, 收入${revenue:.2f}")
        print(f"  盈亏: ${profit:.2f} ({profit_pct:+.2f}%)")
        print(f"  资金池更新: ${pool['total']:.2f}")
        return True

    def get_status(self):
        """获取当前状态"""
        total_cash = 0
        total_position = 0

        for symbol, pool in self.pools.items():
            total_cash += pool['cash']
            total_position += pool['position']

        return {
            'total_assets': total_cash + total_position,
            'total_cash': total_cash,
            'total_position': total_position,
            'cash_ratio': total_cash / (total_cash + total_position)
        }


# 使用示例
portfolio = PortfolioManager(initial_capital=100000)

# 第1天：MSFT买入信号
portfolio.buy('MSFT', price=400)

# 第10天：GOOGL买入信号
portfolio.buy('GOOGL', price=150)

# 第30天：MSFT卖出信号
portfolio.sell('MSFT', price=450)

# 第40天：MSFT再次买入信号（复利）
portfolio.buy('MSFT', price=420)

# 查看状态
status = portfolio.get_status()
print(f"总资产: ${status['total_assets']:.2f}")
print(f"现金比例: {status['cash_ratio']*100:.1f}%")
```

---

## 🎯 核心结论

### 1. 推荐买入比例

```yaml
MSFT (A级):  60%  # 高信心高仓位
GOOGL (B级): 50%  # 平衡
NVDA (C级):  40%  # 低信心低仓位
TSLA (C级):  40%
AAPL (C级):  30%  # 最低
```

### 2. 关键原则

1. ✅ **动态复利**：盈利归入资金池，下次买入自动增加
2. ✅ **保留现金**：不要100% all-in，保留40-70%应对后续信号
3. ✅ **分级配置**：高评级高比例，低评级低比例
4. ✅ **独立管理**：各股票资金池独立，不互相影响

### 3. 预期效果

```
使用50%平衡买入比例:
  连续3次盈利10% → 总盈利15.8%

使用70%激进买入比例:
  连续3次盈利10% → 总盈利22.5%
  但风险更高，现金储备少

推荐: 50-60%买入比例
```

### 4. 风险控制

```yaml
单次止损:
  - 单笔亏损>10% → 立即平仓

资金池止损:
  - 某股票资金池亏损>20% → 暂停该股票交易
  - 例如AAPL从$10,000降至$8,000 → 暂停

组合止损:
  - 总资产亏损>15% → 全部减仓50%
  - 总资产亏损>25% → 全部平仓
```

---

**总结**: 使用分级固定比例（A级60%、B级50%、C级30-40%）+ 动态复利，既能享受复利增长，又能控制风险。
