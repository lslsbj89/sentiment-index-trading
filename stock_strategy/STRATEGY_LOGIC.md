# 回测策略详细说明

**测试日期**: 2026-01-20
**策略名称**: Fear & Greed Index 情绪指数策略
**测试期间**: 2021-01-01 至 2025-12-31

---

## 🎯 核心策略逻辑

### 策略原理

利用**情绪指数（Fear & Greed Index）**判断市场情绪，在恐慌时买入，在贪婪时卖出。

**情绪指数说明**:
- **指数 < 0**: 市场恐慌
- **指数 0~20**: 轻度恐慌
- **指数 20~50**: 中性
- **指数 50~70**: 轻度贪婪
- **指数 > 70**: 极度贪婪

---

## 📊 买入条件（Buy Logic）

### 主要条件
```python
if position == 0 and current_idx < buy_threshold:
    BUY
```

**触发条件**:
1. ✅ 当前**空仓**（position == 0）
2. ✅ 情绪指数**低于买入阈值**（current_idx < buy_threshold）

### 买入阈值（各股票不同）

#### Smoothing=3 个股优化参数
| 股票 | buy_threshold | 含义 |
|------|--------------|------|
| NVDA | < 10 | 轻度恐慌即买入 |
| TSLA | < -10 | **极度恐慌**才买入 🔥 |
| GOOGL | < 10 | 轻度恐慌即买入 |
| AAPL | < -10 | **极度恐慌**才买入 🔥 |
| MSFT | < 0 | 市场恐慌即买入 |
| AMZN | < 0 | 市场恐慌即买入 |
| META | < 0 | 市场恐慌即买入 |

#### Smoothing=5 个股优化参数
| 股票 | buy_threshold | 含义 |
|------|--------------|------|
| NVDA | < 10 | 轻度恐慌即买入 |
| TSLA | < -10 | **极度恐慌**才买入 🔥 |
| GOOGL | < 10 | 轻度恐慌即买入 |
| AAPL | < -5 | 深度恐慌才买入 |
| MSFT | < 10 | 轻度恐慌即买入 |
| AMZN | < 5 | 中性偏恐慌买入 |
| META | < -10 | **极度恐慌**才买入 🔥 |

#### 统一参数
| 场景 | buy_threshold | 含义 |
|------|--------------|------|
| S3统一 | < 0 | 市场恐慌即买入 |
| S5统一 | < 5 | 中性偏恐慌买入 |

### 仓位计算
```python
available = cash * 0.8  # 使用80%现金
shares = int(available / (current_price * 1.002))
cost = shares * current_price * 1.002
```

**仓位规则**:
- 使用现金的**80%**买入
- 预留**20%**现金（防止强制平仓、应急）
- 成本包含**0.2%交易成本**（0.1%手续费 + 0.1%滑点）

**示例**（NVDA指数=8时）:
```
当前现金: $100,000
可用资金: $100,000 × 80% = $80,000
NVDA价格: $47.67
买入成本: $47.67 × 1.002 = $47.77 (含0.2%成本)
买入股数: $80,000 / $47.77 = 1,675股
实际成本: 1,675 × $47.77 = $80,014.75
剩余现金: $19,985.25
```

---

## 📉 卖出条件（Sell Logic）

### 三种卖出条件（满足任一即卖出）

#### 条件1: OR卖出（无条件卖出）
```python
if current_idx > sell_or_threshold:
    SELL  # OR卖出
```

**触发条件**:
- 情绪指数**超过OR阈值** → 市场过于贪婪，立即卖出

**OR阈值（各股票不同）**:

| 股票 | S3 or阈值 | S5 or阈值 |
|------|----------|----------|
| NVDA | > 70 | > 50 |
| TSLA | > 50 | > 35 |
| GOOGL | > 70 | > 50 |
| AAPL | > 40 | > 35 |
| MSFT | > 40 | > 50 |
| AMZN | > 60 | > 35 |
| META | > 70 | > 45 |

**示例**:
- NVDA指数从8升至71 → 触发OR卖出（S3阈值70）
- 立即卖出全部持仓

---

#### 条件2: AND卖出（条件卖出）
```python
if current_idx > sell_and_threshold and current_price < current_ma50:
    SELL  # AND卖出
```

**触发条件**（需同时满足）:
1. ✅ 情绪指数**超过AND阈值**
2. ✅ 当前价格**跌破MA50**（50日均线）

**AND阈值（各股票不同）**:

| 股票 | S3 and阈值 | S5 and阈值 |
|------|-----------|-----------|
| NVDA | > 30 | > 30 |
| TSLA | > 25 | > 20 |
| GOOGL | > 30 | > 30 |
| AAPL | > 15 | > 25 |
| MSFT | > 25 | > 30 |
| AMZN | > 15 | > 15 |
| META | > 15 | > 15 |

**示例**（NVDA）:
```
当前指数: 31 (超过and阈值30) ✅
当前价格: $115.76
MA50: $132.88
价格 < MA50? Yes ✅

→ 触发AND卖出
```

**逻辑**:
- 指数升至30+（贪婪），但价格跌破MA50 → 趋势转弱
- 提前止盈/止损

---

#### 条件3: 期末强制平仓
```python
if position > 0:  # 回测结束时
    SELL  # 期末平仓
```

**触发条件**:
- 回测期结束（2025-12-31）仍有持仓
- 强制按最后一天收盘价卖出

---

### 卖出价格计算
```python
revenue = position * current_price * 0.998
```

**成本**:
- 扣除**0.2%交易成本**（0.1%手续费 + 0.1%滑点）

**示例**:
```
持仓: 1,675股 NVDA
卖出价格: $90.18
卖出收入: 1,675 × $90.18 × 0.998 = $150,741.23
扣除成本: $150,741.23 - $151,052 = -$310.77 (0.2%)
```

---

## ⏱️ 持仓时间

### 无固定持仓期限

**特点**:
- ❌ 没有固定60天持仓限制（早期测试有，现已移除）
- ✅ 只要不触发卖出条件，可以一直持仓
- ✅ 由情绪指数和价格走势决定卖出时机

**实际数据（NVDA S3）**:
- 最短持仓: 25天（交易#10，触发AND卖出）
- 最长持仓: 多笔持仓接近回测期末
- 并非都是60天（之前版本有60天限制，现已移除）

---

## 💰 资金管理

### 初始资金
```python
cash = 100000  # $100,000
```

### 仓位管理
- **买入**: 使用80%现金
- **预留**: 20%现金备用

### 收益计算
```python
final_value = cash + position * final_price
total_return = (final_value - 100000) / 100000 * 100
```

**示例（NVDA S3最终）**:
```
初始资金: $100,000
最终资金: $524,498
总收益: ($524,498 - $100,000) / $100,000 = 424.50%
```

---

## 📊 完整交易流程示例

### 案例: NVDA 交易#9 (最佳交易)

#### 买入阶段
```
日期: 2024-01-03
情绪指数: 8.34 < 10 ✅ (满足buy_threshold)
价格: $47.67
MA50: $46.93

→ 触发买入
  可用资金: $152,672 × 80% = $122,137
  买入成本: $47.67 × 1.002 = $47.77
  买入股数: $122,137 / $47.77 = 2,556股
  实际花费: $122,161
  剩余现金: $30,511
```

#### 持仓期间（监控）
```
每日检查:
1. 指数是否 > 70? (OR卖出)
2. 指数是否 > 30 且 价格 < MA50? (AND卖出)

如果都不满足 → 继续持仓
```

#### 卖出阶段（60天后）
```
日期: 2024-04-01
情绪指数: 41.36 (未超70，不触发OR)
价格: $90.18
MA50: $77.60
价格 < MA50? No (不触发AND)

→ 未触发任何卖出条件，但由于早期版本有60天限制
  所以在第60天强制卖出

卖出价格: $90.18 × 0.998 = $90.00
卖出收入: 2,556 × $90.00 = $230,040
收益: $230,040 - $122,161 = $107,879
收益率: +88.3%
```

---

## 🎯 参数对比总结

### Smoothing=3 vs Smoothing=5

| 参数 | S3范围 | S5范围 | 差异 |
|------|--------|--------|------|
| **buy** | -10 ~ +10 | -10 ~ +10 | 相同 |
| **and** | 15 ~ 30 | 15 ~ 30 | 相同 |
| **or** | 40 ~ 70 | 35 ~ 50 | S3更高 |

**关键差异**:
- S3的or阈值更高（40~70 vs 35~50）
- 因为S3指数波动更大，需要更高的卖出阈值

---

## 🔍 策略特点

### 优势
1. ✅ **逆向思维**: 恐慌时买入，贪婪时卖出
2. ✅ **客观信号**: 基于情绪指数，非主观判断
3. ✅ **趋势确认**: AND卖出结合MA50，避免假突破
4. ✅ **风控到位**: 80%仓位，预留20%现金

### 劣势
1. ⚠️ **无止损**: 没有固定止损线（如-15%）
2. ⚠️ **熊市脆弱**: 2022年熊市亏损较多
3. ⚠️ **OR阈值高**: 很少触发（NVDA 15笔中0次）
4. ⚠️ **买入过早**: 可能在下跌趋势中过早买入

---

## 📈 实际表现

### NVDA (Smoothing=3, 个股优化)
- **参数**: buy<10, and>30, or>70
- **交易次数**: 15笔
- **胜率**: 73.3% (11盈4亏)
- **总收益**: +424.50%
- **最大单笔盈利**: +89.19% (交易#9)
- **最大单笔亏损**: -38.96% (交易#4, 2022熊市)

### 退出原因分布（NVDA 15笔）
- **早期测试60天超时**: 大部分 (86.7%)
- **AND卖出**: 1笔 (6.7%)
- **OR卖出**: 0笔 (0%)
- **期末平仓**: 1笔 (6.7%)

**发现**: OR=70阈值过高，从未触发

---

## 💡 改进建议

基于实际测试结果，建议优化：

### 建议1: 加入止损
```python
if profit_pct <= -15%:
    SELL  # 止损
```

### 建议2: 降低OR阈值
```python
# NVDA: or=70 → or=50
# 更及时止盈
```

### 建议3: 分批建仓
```python
if idx < -10:
    position_pct = 0.8  # 极度恐慌→重仓
elif idx < 0:
    position_pct = 0.6  # 恐慌→中仓
else:
    position_pct = 0.4  # 轻度恐慌→轻仓
```

---

**文档生成**: 2026-01-20
**策略版本**: v1.0 (公平对比测试版)
**测试数据**: 2021-2025实际回测
